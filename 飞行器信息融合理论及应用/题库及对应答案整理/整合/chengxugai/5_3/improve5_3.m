% 一个标准的Kalman滤波器
% alpha-beta-gama滤波（针对位置、速度、加速度的三状态滤波器）
% 系统模型 x[k+1] = Phi * x[k] + G * w[k]
% 量测模型 z[k] = H * x[k] + v[k]

clear all;      % 清除工作区所有变量
close all;      % 关闭所有图形窗口

% ========== 系统参数设置 ==========
T = 0.2;        % 采样间隔时间

% 状态转移矩阵（针对匀加速运动模型）
% 状态向量 x = [位置; 速度; 加速度]
Phi = [1 T  0.5*T^2; 0 1 T; 0 0 1];

% 过程噪声驱动矩阵（假设只有加速度受噪声影响）
G = [0 0 T]';   % 加加速度为白噪声

% 观测矩阵（只对位置进行测量）
H = [1 0 0];

% ========== 噪声方差阵以及初值设置 ==========
Q = 0.1;        % 过程噪声方差
R = 0.04;       % 观测噪声方差
I = eye(3);     % 3x3单位矩阵

% 初始化状态向量
xr(:,1) = randn(3,1);   % 假设状态真实值（随机初始状态）
xe(:,1) = zeros(3,1);   % 初始状态估计值（设为0）

% 初始化协方差矩阵
Ppos = eye(3);          % 初始后验估计误差协方差
Ppre(:,1) = diag(Ppos); % 存储先验协方差对角元素
Pest(:,1) = diag(Ppos); % 存储后验协方差对角元素

% ========== 主循环：Kalman滤波过程 ==========
for i = 2:100
    % ----- 状态预测（时间更新） -----
    x(:,i) = Phi * xe(:,i-1);                    % 状态预测
    Pneg = Phi * Ppos * Phi' + G * Q * G';       % 协方差预测
    Ppre(:,i) = diag(Pneg);                      % 提取对角元素用于绘图
    
    % ----- 过程噪声附加（模拟真实系统） -----
    w = Q^0.5 * randn;                           % 生成过程噪声
    xr(:,i) = Phi * xr(:,i-1) + G * w;           % 实际状态值（含噪声）
    
    % ----- 量测噪声附加 -----
    v = Q^0.5 * randn;                           % 生成观测噪声
    z(:,i) = H * xr(:,i) + v;                    % 生成量测值
    
    % ----- 滤波计算（量测更新）过程 -----
    K(:,i) = Pneg * H' * inv(H * Pneg * H' + R); % 计算Kalman增益
    % 更新后验协方差（使用更稳定的Joseph形式）
    Ppos = (I - K(:,i) * H) * Pneg * (I - K(:,i) * H)' + K(:,i) * R * K(:,i)';
    Pest(:,i) = diag(Ppos);                      % 提取对角元素用于绘图
    xe(:,i) = x(:,i) + K(:,i) * (z(:,i) - H * x(:,i)); % 状态估计值更新
end

% ========== 稳态Kalman滤波器 ==========
% 计算稳态增益（当协方差矩阵收敛时的增益）
Ks = Ppos * H' * 1 / R;                          % 稳态Kalman增益
xe1(:,1) = zeros(3,1);                           % 初始化稳态滤波器状态

% 使用稳态增益进行滤波
for i = 2:100
    xe1(:,i) = Phi * xe1(:,i-1) + Ks * (z(:,i) - H * Phi * xe1(:,i-1));
end

% ========== 结果可视化 ==========
t = T * (1:100);     % 生成时间向量

% 图1：位移估计误差对比
figure(1);
plot(t, abs(x(1,:) - xr(1,:)), 'k', ...         % 预测值误差
     t, abs(xe(1,:) - xr(1,:)), 'ro-', ...      % Kalman滤波误差
     t, abs(xe1(1,:) - xr(1,:)), 'b*-');        % 稳态增益滤波误差
legend('预测值误差', '滤波误差', '稳态增益滤波误差');
xlabel('时间'), ylabel('位移估计误差');

% 图2：速度估计误差对比
figure(2)
plot(t, abs(x(2,:) - xr(2,:)), 'k', ...         % 预测误差
     t, abs(xe(2,:) - xr(2,:)), 'ro-', ...      % Kalman滤波误差
     t, abs(xe1(2,:) - xr(2,:)), 'b*-');        % 稳态增益滤波误差
legend('预测误差', '滤波误差', '稳态增益滤波误差');
xlabel('时间'), ylabel('速度估计误差');

% 图3：加速度估计误差对比
figure(3)
plot(t, abs(x(3,:) - xr(3,:)), 'k', ...         % 预测误差
     t, abs(xe(3,:) - xr(3,:)), 'ro-', ...      % Kalman滤波误差
     t, abs(xe1(3,:) - xr(3,:)), 'b*-');        % 稳态增益滤波误差
legend('预测误差', '滤波误差', '稳态增益滤波误差');
xlabel('时间'), ylabel('加速度估计误差');

% 图4：协方差矩阵对角线元素变化
figure(4);
plot(t, Ppre(1,:), 'k*--', ...                  % 先验位置方差
     t, Ppre(2,:), 'ko--', ...                  % 先验速度方差
     t, Ppre(3,:), 'k--', ...                   % 先验加速度方差
     t, Pest(1,:), 'ks-', ...                   % 后验位置方差
     t, Pest(2,:), 'kv-', ...                   % 后验速度方差
     t, Pest(3,:), 'k-');                       % 后验加速度方差
legend('p11(-)', 'p22(-)', 'p33(-)', 'p11(+)', 'p22(+)', 'p33(+)');
xlabel('时间'); ylabel('P阵对角线元素');

% 图5：Kalman增益变化过程
figure(5)
plot(t, K(1,:), 'k-', ...                       % 位移增益
     t, K(2,:), 'k*-', ...                      % 速度增益
     t, K(3,:), 'kv-');                         % 加速度增益
legend('位移增益', '速度增益', '加速度增益');
xlabel('时间'); ylabel('滤波增益');

% ========== 结果的简单说明 ==========
% 系统实际上是由白噪声（加加速度）驱动，其中加速度就表现为随机游走特性
% 本例中P阵实际上提取了估计误差阵Ppos的对角线元素
% 这是一个典型的α-β-γ滤波器，用于跟踪具有随机加速度的目标