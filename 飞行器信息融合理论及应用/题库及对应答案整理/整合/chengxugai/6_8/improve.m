% 有色噪声Kalman滤波器
% 假设alpha-beta-gama滤波中的加加速度非白噪声而为一阶Markov过程
% 进行状态扩维后滤波程序如下
% alpha-beta-gama滤波
% 系统模型 x[k+1] = Phi * x[k] + WN[k]
% 噪声模型 WN[k+1] = exp(-a*T)WN[k] + sigma*sqrt(1-exp(-2*a*T))*w[k]
% 量测模型 z[k] = H * x[k] + v[k]

clear all;  % 清除工作区所有变量
close all;  % 关闭所有图形窗口
clc         % 清空命令窗口

% ========== 系统参数设置 ==========
T = 0.2;    % 采样间隔时间

% 噪声方差阵以及初值设置
Q = 0.9;                    % 过程噪声方差
sigma = sqrt(Q);            % 过程噪声标准差
R = 0.6;                    % 观测噪声方差
I = eye(4);                 % 4x4单位矩阵
N = 200;                    % 总采样点数
a = 0.11;                   % Markov过程的时间常数

% ========== 生成噪声序列 ==========
w = sigma * sqrt(1 - exp(-2*a*T)) * randn(N,1);  % 生成过程噪声序列
v = R^0.5 * randn(N,1);                          % 生成观测噪声序列

% ========== 扩维后的系统模型 ==========
% 状态转移矩阵（扩维到4维：位置、速度、加速度、加加速度）
% 加加速度建模为一阶Markov过程
Phi = [1 T  0.5*T^2 1/6*T^3; 0 1 T 0.5*T^2; 0 0 1 T; 0 0 0 exp(-a*T)];
G = [0 0 0 1]';             % 噪声驱动矩阵
H = [1 0 0 0];              % 观测矩阵（只对位置进行测量）

% ========== 生成真实状态序列 ==========
xr(:,1) = zeros(4,1);       % 初始化真实状态
xr(4,1) = w(1,1);           % 初始加加速度值
for i = 2:N
    xr(:,i) = Phi * xr(:,i-1) + G * w(i,1);  % 状态更新（含过程噪声）
    z(:,i) = H * xr(:,i) + v(i,1);           % 生成观测值（含观测噪声）
end

% ========== 扩维Kalman滤波器初始化 ==========
xe(:,1) = zeros(4,1);       % 初始状态估计值
Ppos = eye(4);              % 初始后验估计误差协方差
Ppre(:,1) = diag(Ppos);     % 存储先验协方差对角元素
Pest(:,1) = diag(Ppos);     % 存储后验协方差对角元素

% ========== 扩维Kalman滤波主循环 ==========
for i = 2:N
    % ----- 状态预测（时间更新） -----
    x(:,i) = Phi * xe(:,i-1);                    % 状态预测
    Pneg = Phi * Ppos * Phi' + G * Q * G';       % 协方差预测
    Ppre(:,i) = diag(Pneg);                      % 提取对角元素
    
    % ----- 滤波计算（量测更新）过程 -----
    K(:,i) = Pneg * H' * inv(H * Pneg * H' + R); % 计算Kalman增益
    Ppos = (I - K(:,i) * H) * Pneg;              % 更新后验协方差
    Pest(:,i) = diag(Ppos);                      % 提取对角元素
    xe(:,i) = x(:,i) + K(:,i) * (z(:,i) - H * x(:,i)); % 状态估计值更新
end

% ========== 标准Kalman滤波器（将有色噪声近似为白噪声） ==========
% 使用3状态模型，假设加加速度为白噪声
Phi1 = Phi(1:3,1:3);        % 提取前3x3状态转移矩阵
G1 = [0 0 T]';              % 噪声驱动矩阵
H1 = [1 0 0];               % 观测矩阵
I1 = eye(3);                % 3x3单位矩阵

% 标准Kalman滤波器初始化
xe1(:,1) = zeros(3,1);      % 初始状态估计值
Ppos1 = eye(3);             % 初始后验估计误差协方差
Ppre1(:,1) = diag(Ppos1);   % 存储先验协方差对角元素
Pest1(:,1) = diag(Ppos1);   % 存储后验协方差对角元素

% ========== 标准Kalman滤波主循环 ==========
for i = 2:N
    % ----- 状态预测（时间更新） -----
    x1(:,i) = Phi1 * xe1(:,i-1);                    % 状态预测
    Pneg1 = Phi1 * Ppos1 * Phi1' + G1 * Q * G1';    % 协方差预测
    Ppre1(:,i) = diag(Pneg1);                       % 提取对角元素
    
    % ----- 滤波计算（量测更新）过程 -----
    K1(:,i) = Pneg1 * H1' * inv(H1 * Pneg1 * H1' + R); % 计算Kalman增益
    Ppos1 = (I1 - K1(:,i) * H1) * Pneg1;            % 更新后验协方差
    Pest1(:,i) = diag(Ppos1);                       % 提取对角元素
    xe1(:,i) = x1(:,i) + K1(:,i) * (z(:,i) - H1 * x1(:,i)); % 状态估计值更新
end

% ========== 性能评估 ==========
% 计算位置估计误差
pos_diff = xe(1,:) - xr(1,:);      % 扩维滤波器的位置误差
pos_diff1 = xe1(1,:) - xr(1,:);    % 标准滤波器的位置误差

% 计算误差统计量
pos_diff_m = mean(pos_diff);       % 扩维滤波器误差均值
pos_diff_s = std(pos_diff);        % 扩维滤波器误差标准差
pos_diff_m1 = mean(pos_diff1);     % 标准滤波器误差均值
pos_diff_s1 = std(pos_diff1);      % 标准滤波器误差标准差

% ========== 结果可视化 ==========
t = (1:N) * T;  % 生成时间向量

% 绘制位置误差对比图
plot(t, pos_diff, 'b-', t, pos_diff1, 'ro--'),
legend('状态扩展', '近似为白噪声');
xlabel('时间(s)'), ylabel('位置误差(m)');
title('有色噪声处理方法的性能比较');

% ========== 结果显示 ==========
fprintf('扩维滤波器 - 位置误差均值: %.4f, 标准差: %.4f\n', pos_diff_m, pos_diff_s);
fprintf('标准滤波器 - 位置误差均值: %.4f, 标准差: %.4f\n', pos_diff_m1, pos_diff_s1);

% 说明：
% 1. 扩维滤波器通过将加加速度（有色噪声）作为状态变量，能够更准确地建模系统动态
% 2. 标准滤波器将有色噪声近似为白噪声，会引入模型误差
% 3. 从误差统计量可以比较两种方法的性能优劣